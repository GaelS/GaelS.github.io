<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="IntroductionDans un précédent article, nous avons vu comment implémenter de façon naïve la librairie Redux. Si vous ne l’avez pas encore lu ou que vou"><meta name="author" content="Gaël Servaud"><meta property="og:title" content="React Redux from scratch"><meta property="og:site_name" content="Apprendre ReactJS"><meta property="og:type" content="article"><meta name="twitter:card" content="summary"><title>React Redux from scratch - Apprendre ReactJS</title><link rel="stylesheet" href="//unpkg.com/tachyons/css/tachyons.min.css"><link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"><!--[if lt IE 9]>
        <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]--><link rel="stylesheet" href="/css/style.css"><script>!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-96190899-1","auto"),ga("send","pageview")</script></head><body><div class="w-100 bg-1 ph5-ns ph3 text-light"><nav class="db dt-l w-100 mw8 center border-box pv3"><a class="db dtc-l v-mid link dim w-100 w-25-l tc tl-l mb2 mb0-l white" href="/" title="Apprendre ReactJS"><img src="/images/ReactLogo.svg" class="dib h3" alt="Apprendre ReactJS"></a><div class="db dtc-l v-mid w-100 w-75-l tc tr-l"><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/" title="Home">Home </a><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/archives" title="Archives">Archives </a><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/about" title="A propos">A propos</a></div></nav><div class="w-100 mw8 center vh-40 dt"><div class="dtc v-mid white"><h1 class="f1-l f2-m tc tc-m tl-ns">React Redux from scratch</h1><p class="f4 fw3 pab-100px tc tc-m tl-ns">04/06/2017</p></div></div><div class="relative w-100 mw8 center white dn dn-m db-ns"><i class="header-icon fa fa-code"></i></div></div><div class="w-100 ph2 ph4-m ph5-l mv5 mv6-l"><div class="content"><div class="mw8 center"><div class="cf"><div class="fl w-100 w-70-l mw7 left fw3 lh-copy pr4-ns pr0-m post-content"><div class="tags-container-vertical"><div class="tags-sub-container"><a class="fw3 ph1 dib" href="/tags/redux/">#redux</a> <a class="fw3 ph1 dib" href="/tags/react-redux/">#react-redux</a></div></div><h3 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h3><p>Dans un précédent article, nous avons vu comment implémenter de façon naïve la librairie Redux. Si vous ne l’avez pas encore lu ou que vous souhaitez simplement le relire, c’est par ici: <a href="/tutorial/library/flux/redux-from-scratch/">Redux from scratch</a></p><p>À l’issue du tuto précédent, on avait donc un store qui mettait à jour nos composants React. On pouvait être satisfait! Seulement, on pouvait réaliser les limites de notre implémentation… En effet, chaque composant dépendant de notre store doit nécessairement l’importer et y <em>subscriber</em> dans la méthode <code>componentDidMount</code> de la façon suivante: <code>store.subscribe(() =&gt; this.forceUpdate)</code>.</p><p>Certes, ça ne représente que deux lignes de code dans chaque fichier mais cela nous amène à écrire un peu partout du code identique en plus de lier très fortement nos composants à l’implémentation de notre <em>store</em>. Ce qui est problématique si à terme, on souhaite publier nos composants sur npm par exemple.</p><p>La solution existe déjà et s’appelle <em>React Redux</em> et nous allons l’implémenter ensemble !</p><h3 id="Store-everywhere…"><a href="#Store-everywhere…" class="headerlink" title="Store everywhere…"></a>Store everywhere…</h3><p>Chacun des composants ayant besoin du state et des méthodes à <em>dispatcher</em> doit d’avoir accès d’une façon ou d’une autre au <em>store</em>. Il faut donc que ce dernier soit disponible PARTOUT!</p><p>Deux options s’offrent à nous :<br>1) Transmettre le <em>store</em> depuis le composant <code>App</code>, le composant le plus haut dans l’arborescence de l’application, en <em>props</em> à tous les composants enfants.<br>2) Utiliser le <a href="https://facebook.github.io/react/docs/context.html" target="_blank" rel="noopener">contexte</a></p><p>L’option numéro 1, on le réalise vite, va se révéler fastidieuse quand le composant tout en bas, bien loin en bas, de notre arborescence, aura besoin d’accéder au <em>store</em>. On va se retrouver un ensemble de composant qui se passeront gentiment le <code>store</code> jusqu’à celui qui en aura forcément besoin…</p><p>Bon j’avoue la comparaison est un peu biaisé, mais l’option 2 utilise la notion de contexte hors, le contexte dans React vient justement pour éviter les biais de l’option 1. Le contexte (un simple objet javascript) se définit au sein d’un composant et est transmis par défaut à tous les composants enfants. Cela veut dire que si nécessaire, les composants enfant pourront accéder à cet objet pour l’utiliser. Ainsi, même un le composant au bout du bout de l’arborescence pourra utiliser le contexte définit 10 niveaux de hiérarchie au dessus de lui de façon très simple.</p><p>C’est donc évidemment cette option que nous allons utiliser pour rendre notre <em>store</em> disponible partout dans notre application.</p><p>On va donc tenter d’écrire un composant <code>Provider</code> qui viendra <em>wrapper</em> le composant principal <code>App</code> qui permettra de rendre accessible le <em>store</em> partout dans notre application et nous fera réécrire le fichier <em>index.js</em> de cette façon :</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//index.js</span></div><div class="line"></div><div class="line"><span class="comment">/* import stuff .... */</span></div><div class="line">ReactDOM.render(</div><div class="line">    &lt;Provider store=&#123;store&#125;&gt;</div><div class="line">      &lt;App/&gt;</div><div class="line">    &lt;/Provider&gt;,</div><div class="line">  <span class="built_in">document</span>.getElementById(<span class="string">'root'</span>)</div><div class="line">);</div></pre></td></tr></table></figure><p>Ce <code>Provider</code> est donc un élément React qui prend un seul props : le <code>store</code> si vous avez suivi et va donc le rendre disponible via le contexte aux composant enfant.</p><p>Comment fait-on cela me direz-vous ? On va y aller par étape.<br>Premièrement, ce composant ne gère aucun affichage en tant que tel, il se contente de transmettre de l’information aux composants enfants mais ne va en aucun cas modifier l’UI :</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//provider.js</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Provider</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</div><div class="line">  render() &#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.props.children;</div><div class="line">  &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure><p>On a maintenant un composant simple qui se contente de rendre son props <code>children</code>. Là en l’occurence, avec ou sans <code>Provider</code>, rien n’a changé pour notre application si ce n’est un niveau de hiérarchie supplémentaire dans notre arbre de composants.</p><p>On va maintenant rendre <code>Provider</code> vraiment utile. Pour créer un contexte, il faut utiliser la méthode <code>getChildContext</code>, méthode qui retourne un objet qui sera le contexte auquel les composants enfants auront accès. Ici, cete méthode va retourner le <code>store</code> qui est passé en <code>props</code> à notre composant <code>Provider</code>.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//provider.js</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Provider</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</div><div class="line">  <span class="comment">//Création du context</span></div><div class="line">  getChildContext = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">    <span class="keyword">return</span> &#123; <span class="attr">store</span>: <span class="keyword">this</span>.props.store &#125;;</div><div class="line">  &#125;</div><div class="line">  render() &#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.props.children;</div><div class="line">  &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure><p>Pour que ce soit totalement complet et fonctionnel, il faut rajouter, en plus de cette méthode, le type des attributs que le contexte contient (<a href="https://facebook.github.io/react/docs/context.html" target="_blank" rel="noopener">la docs est ici</a> ).<br>Ainsi, <code>Provider</code> va finalement s’écrire de la façon suivante:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//provider.js</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Provider</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</div><div class="line">  <span class="comment">//Création du context</span></div><div class="line">  getChildContext = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">    <span class="keyword">return</span> &#123; <span class="attr">store</span>: <span class="keyword">this</span>.props.store &#125;;</div><div class="line">  &#125;</div><div class="line">  render() &#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.props.children;</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">Provider.childContextTypes = &#123;</div><div class="line">  <span class="attr">store</span>: PropTypes.object,</div><div class="line">&#125;;</div></pre></td></tr></table></figure><p>Done, notre composant <code>Provider</code> est maintenant capable de passer le <code>store</code> en context. le <code>store</code> est accessible à tous les composants enfant, VICTOIRE !!<br>Euh…attendez, pour le moment, on a rien simplifié puisque en l’état, il faut que l’on récupère le contexte dans tous les composants qui utilisent le <code>store</code> et ensuite, nous devons toujours <code>subscriber</code> aux mises à jour et <code>dispatcher</code> les actions. Finalement, on s’évite un import de fichier mais nos composant restent toujours très lié à l’implémentation de notre <code>store</code>, donc en l’état, on ne s’est pas encore simplifié la vie…. Comment changer ça ?</p><h3 id="Single-store-looking-for-soul-mate-s-answer-please…"><a href="#Single-store-looking-for-soul-mate-s-answer-please…" class="headerlink" title="Single store looking for soul mate(s), answer please…"></a>Single store looking for soul mate(s), answer please…</h3><p>Ce que l’on souhaite, c’est que nos composants React soient totalement découplés du <code>store</code>, qu’ils n’aient pas besoin de <code>subscriber</code>, de connaître les actions du <code>store</code> ou d’appeler directement <code>getState</code>. On veut des composants simples, qui reçoivent des <code>props</code> et gèrent un rendu en conséquence, point à la ligne.</p><p>C’est ce que nous permet la fonction <code>connect</code> de React-Redux, et c’est cette méthode que nous allons réimplémenter. Cette fonction va nous permettre de retourner d’office un composant React couplé au <code>store</code>. Elle s’utilise de a façon suivante:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">connect(mapDispatchToProps, mapStateToProps)(ComponsantQueLonSouhaiteLierAuStore);</div></pre></td></tr></table></figure><p>Ouch, entre la fonction qui retourne une fonction, des noms d’arguments à rallonge mais WHAT?, c’est l’anarchie ce truc ?! Pas de panique, on va y aller en douceur :)</p><p>Ce qu’il faut avoir à l’esprit avant toute chose, c’est que l’idée de <code>connect</code>, c’est d’encapsuler un composant (en l’occurence dans notre exemple précédent, le bien-nommé <code>ComponsantQueLonSouhaiteLierAuStore</code> afin de lui fournir tous les <code>props</code> dont il a besoin sans pour s’afficher sans se soucier du <code>store</code>.</p><p>Il se contenet de récupérer les élements et de les afficher, fin.</p><p>Les 2 arguments de <code>connect</code> sont des fonctions et possède des noms assez explicites pour les anglophones. La fonction <code>mapDispatchToProps</code> (resp. <code>mapStateToProps</code>) prend pour argument <code>dispatch</code> (resp. <code>state</code>) et a pour objectif de retourner un objet constitué d’éléments dérivés de la fonction <code>dispatch</code> (resp. de l’objet <code>state</code>).</p><p>Pour le moment, on va s’arrêter à ça, nous verrons leur utilisation dans un cas pratique. Pour le moment, ce qui est essentiel à savoir c’est que ces deux fonctions dépendent de <code>dispatch</code> et <code>state</code> et retourne des objets.</p><p>Pour le moment, on comprend que cette méthode prend deux arguments et retourne une fonction qui prend en argument un composant React:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//connect.js</span></div><div class="line"><span class="comment">/**</span></div><div class="line">  imports...</div><div class="line">**/</div><div class="line"><span class="function"><span class="keyword">function</span>(<span class="params">mapDispatchToProps, mapStateToProps</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">Component</span>) </span>&#123;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>Jusqu’ici, ça va. Maintenant, qu’est-ce que l’on voulait déjà ? Ah oui, retourner le composant React en argument avec les <code>props</code> reçus ! Pour cela, on va enrichir un peu le code précédent :</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span>(<span class="params">mapDispatchToProps, mapStateToProps</span>) </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">Component</span>) </span>&#123;</div><div class="line">    <span class="comment">//finalement on retourne en output de la fonction le componsant avec ses props</span></div><div class="line">    <span class="keyword">return</span> &lt;Component &#123;...props&#125; /&gt;;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>Maintenant, on a bien une fonction qui retourne une fonction retournant elle-même un composant React. Sweet !<br>Seulement, on n’utilise même pas <code>mapDispatchToProps</code> et <code>mapStateToProps</code>. On se contente de retourner <code>Component</code> sans le modifier. On va donc enrichir tout ça.</p><p>Pour rappel <code>mapDispatchToProps</code> et <code>mapStateToProps</code> prennent respectivement les objets <code>dispatch</code> et <code>state</code> contenu dans notre objet <code>store</code>. Il faut donc accéder au <code>store</code>. Comment faire ? Et oui grace au contexte de l’objet <code>Provider</code> !</p><p>On va donc créer un composant React au sein de la fonction dont la charge sera de recupérer le contexte et de retourner dans sa méthode <code>render</code>, l’argument <code>Component</code>, l’argument de notre fonction qui aura été un peu enrichi pour l’occasion.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span>(<span class="params">mapDispatchToProps, mapStateToProps</span>) </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">Component</span>) </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">//Création d'un composant React</span></div><div class="line">    <span class="comment">//qui retourne l'argument</span></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ConnectedComponent</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</div><div class="line">      render() &#123;</div><div class="line">        <span class="keyword">return</span> &lt;Component &#123;...this.props&#125; /&gt;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    //pour accéder au contexte,</div><div class="line">    //on ajoute les lignes suivantes</div><div class="line">    ConnectedComponent.contextTypes = &#123;</div><div class="line">      store: PropTypes.object,</div><div class="line">    &#125;;</div><div class="line">    </div><div class="line">    //on le retourne en output de la fonction</div><div class="line">    return ConnectedComponent;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>Maintenant, on a accès à notre <code>store</code> via le context. De façon identique à <code>this.props</code> ou <code>this.state</code>, on accède au context via <code>this.context</code> au sein d’un composant à état ou simplement <code>context</code> dans un composant fonctionnel.</p><p>On peut donc appeler <code>mapDispatchToProps</code> et <code>mapStateToProps</code> avec les arguments attendus.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span>(<span class="params">mapDispatchToProps, mapStateToProps</span>) </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">Component</span>) </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">//Création d'un composant React</span></div><div class="line">    <span class="comment">//qui retourne l'argument</span></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ConnectedComponent</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</div><div class="line">      render() &#123;</div><div class="line">        <span class="comment">//on récupère le store dans le contexte</span></div><div class="line">        <span class="keyword">const</span> store = <span class="keyword">this</span>.context.store;</div><div class="line">        <span class="comment">//on appelle les deux fonctions qui retournent chacune un objet</span></div><div class="line">        <span class="keyword">const</span> propsFromDispatch = mapDispatchToProps(store.dispatch);</div><div class="line">        <span class="keyword">const</span> propsFromState = mapStateToProps(store.getState());</div><div class="line"></div><div class="line">        <span class="keyword">return</span> &lt;Component/&gt;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//pour accéder au contexte,</span></div><div class="line">    <span class="comment">//on ajoute les lignes suivantes</span></div><div class="line">    ConnectedComponent.contextTypes = &#123;</div><div class="line">      <span class="attr">store</span>: PropTypes.object,</div><div class="line">    &#125;;</div><div class="line">    </div><div class="line">    <span class="comment">//on le retourne en output de la fonction</span></div><div class="line">    <span class="keyword">return</span> ConnectedComponent;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>Maintenant, on veux que le composant React en argument de la fonction ait en plus de ses <code>props</code>, les objets générés par <code>mapDispatchToProps</code> et <code>mapStateToProps</code>. On va donc enrichir la méthode <code>render</code> de <code>ConnectedComponent</code>.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//stuff avant</span></div><div class="line">  render() &#123;</div><div class="line">    <span class="comment">//on récupère le store dans le contexte</span></div><div class="line">    <span class="keyword">const</span> store = <span class="keyword">this</span>.context.store;</div><div class="line">    <span class="comment">//on appelle les deux fonctions qui retournent chacune un objet</span></div><div class="line">    <span class="keyword">const</span> propsFromDispatch = mapDispatchToProps(store.dispatch);</div><div class="line">    <span class="keyword">const</span> propsFromState = mapStateToProps(store.getState());</div><div class="line"></div><div class="line">    <span class="keyword">return</span> (</div><div class="line">      &lt;Component</div><div class="line">        &#123;...props&#125;</div><div class="line">        &#123;...propsFromDispatch&#125;</div><div class="line">        &#123;...propsFromState&#125;</div><div class="line">      /&gt;</div><div class="line">    );</div><div class="line">  &#125;</div><div class="line">//stuff après</div></pre></td></tr></table></figure><p>Génial, maintenant, on retourne bien un composant qui possède des informations venant du <code>store</code>. Par contre, on n’oublie quelque chose, en l’état, le composant ne va pas mettre un jour son rendu lorsque le <code>state</code> est modifié, il faut penser à <em>subscriber</em> pour écouter les changements.<br>On obtient donc ceci :</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span>(<span class="params">mapDispatchToProps, mapStateToProps</span>) </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">Component</span>) </span>&#123;</div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ConnectedComponent</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</div><div class="line">      componentDidMount() &#123;</div><div class="line">        <span class="comment">//subscribe pour écouter</span></div><div class="line">        <span class="comment">//les changements au niveau du state</span></div><div class="line">        <span class="keyword">this</span>.context.store.subscribe(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">this</span>.forceUpdate());</div><div class="line">      &#125;</div><div class="line">      render() &#123;</div><div class="line">        <span class="keyword">const</span> &#123;context, props&#125; = <span class="keyword">this</span>;</div><div class="line">        <span class="keyword">const</span> propsFromDispatch = mapDispatchToProps(context.store.dispatch);</div><div class="line">        <span class="keyword">const</span> propsFromState = mapStateToProps(context.store.getState());</div><div class="line">        <span class="keyword">return</span> (</div><div class="line">          &lt;Component </div><div class="line">              &#123;...props&#125;</div><div class="line">              &#123;...propsFromDispatch&#125;</div><div class="line">              &#123;...propsFromState&#125;</div><div class="line">          /&gt;</div><div class="line">        );</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">    ConnectedComponent.contextTypes = &#123;</div><div class="line">      store: PropTypes.object,</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    return ConnectedComponent;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>Maintenant, lorsque l’on fait :<br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">mapDispatchToProps</span> = (<span class="params">dispatch</span>) =&gt; </span>&#123; <span class="comment">/** **/</span> &#125;</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">mapStateToProps</span> = (<span class="params">state</span>) =&gt; </span>&#123; <span class="comment">/** **/</span> &#125;</div><div class="line"><span class="keyword">const</span> connectFunction = connect(mapDispatchToProps, mapStateToProps)</div></pre></td></tr></table></figure><p></p><p>Ici, <code>connectFunction</code> est une fonction qui attend en argument un composant React pour le lier directement au <code>store</code> de façon très simple.</p><p>Ainsi :</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">mapDispatchToProps</span> = (<span class="params">dispatch</span>) =&gt; </span>&#123; onClick: <span class="function"><span class="params">()</span> =&gt;</span> dispatch(actionDeCliquer()) &#125;</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">mapStateToProps</span> = (<span class="params">state</span>) =&gt; </span>&#123; name: state.name &#125;</div><div class="line"><span class="keyword">const</span> UnPetitComposant = <span class="function">(<span class="params">props</span>) =&gt;</span> (</div><div class="line">  &lt;div </div><div class="line">    onClick=&#123;props.onClick&#125;</div><div class="line">    style=&#123;&#123;backgroundColor: props.color&#125;&#125;</div><div class="line">  &gt;</div><div class="line">    &#123;props.name&#125;</div><div class="line">  &lt;/div&gt;</div><div class="line">);</div><div class="line"></div><div class="line"><span class="keyword">const</span> UnPetitcomposantRelieAuStore = connect(mapDispatchToProps, mapStateToProps)(UnPetitComposant)</div><div class="line"></div><div class="line"><span class="comment">//maintenant je peux écrire </span></div><div class="line">&lt;UnPetitcomposantRelieAuStore color=&#123;<span class="string">"blue"</span>&#125; /&gt;</div><div class="line"><span class="comment">//UnPetitComposant est maintenant totalement dissocié de l'implémentation du store</span></div><div class="line"><span class="comment">//il se contente de recevoir des props, du store ou non,</span></div><div class="line"><span class="comment">//et de gérer son affichage en conséquence</span></div></pre></td></tr></table></figure><h3 id="Place-a-la-pratique"><a href="#Place-a-la-pratique" class="headerlink" title="Place à la pratique"></a>Place à la pratique</h3><p>Pour revenir à notre exemple de boîte mail, on va pouvoir modifier de façon assez drastique le ficher principal qui ressemblait au code juste en dessous à l’isue du tutoria sur <code>redux</code>:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line">  imports</div><div class="line">*/</div><div class="line"><span class="keyword">import</span> store <span class="keyword">from</span> <span class="string">'./redux/store'</span>;</div><div class="line"><span class="keyword">import</span> &#123; addMail, removeMail, markMailAsRead &#125; <span class="keyword">from</span> <span class="string">'./redux/actions'</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</div><div class="line"></div><div class="line">  componentDidMount() &#123;</div><div class="line">    store.subscribe(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">this</span>.forceUpdate());</div><div class="line">  &#125;;</div><div class="line">  hitRefreshButton = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">    <span class="keyword">const</span> newMails = <span class="built_in">Math</span>.round(<span class="built_in">Math</span>.random() * <span class="number">4</span>) + <span class="number">1</span>; </div><div class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; newMails; i++) &#123;</div><div class="line">      store.dispatch(addMail());</div><div class="line">    &#125;;</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  render() &#123;</div><div class="line">    <span class="keyword">const</span> mails = store.getState().mails;</div><div class="line">    <span class="keyword">const</span> unreadMails = mails.filter(<span class="function"><span class="params">mail</span> =&gt;</span> !mail.read);</div><div class="line">    <span class="comment">//pour simplifier, je n'ai garder que </span></div><div class="line">    <span class="comment">//les éléments qui nous intéressent :)</span></div><div class="line">    <span class="comment">//d'ou un code bien moins long que dans le projet</span></div><div class="line">    <span class="keyword">return</span> (</div><div class="line">      &#123; <span class="comment">/* stuff */</span>&#125;</div><div class="line">        &lt;div&gt;</div><div class="line">          &lt;Label &gt;</div><div class="line">            &lt;Icon name='mail'/&gt; &#123;unreadMails.length&#125;</div><div class="line">          &lt;/Label&gt;</div><div class="line">        &lt;/div&gt;</div><div class="line">        &lt;div&gt;</div><div class="line">        &lt;Label </div><div class="line">          as="button"</div><div class="line">          content="Refresh" </div><div class="line">          icon="refresh"</div><div class="line">          onClick=&#123;this.hitRefreshButton&#125;</div><div class="line">        /&gt;</div><div class="line">        &lt;/div&gt;</div><div class="line">        &#123;mails.length === <span class="number">0</span> &amp;&amp; &lt;div style=&#123;S.centeredContainer&#125;&gt;</div><div class="line">          &lt;div&gt;No new mail, have a good day !&lt;/div&gt;</div><div class="line">          &lt;/div&gt;</div><div class="line">        &#125;</div><div class="line">        &#123; mails.map( <span class="function">(<span class="params">mail, index</span>) =&gt;</span> (</div><div class="line">          &lt;Mail </div><div class="line">            key=&#123;mail.object&#125;</div><div class="line">            mail=&#123;mail&#125;</div><div class="line">            index=&#123;index&#125;</div><div class="line">            onDelete=&#123; () =&gt; store.dispatch(removeMail(index)) &#125;</div><div class="line">            onClickAsRead=&#123; () =&gt; store.dispatch(markMailAsRead(index))&#125; </div><div class="line">            /&gt;</div><div class="line">          ) </div><div class="line">        ) &#125;</div><div class="line">    );</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">export default App;</div></pre></td></tr></table></figure><p>On voit ici qu’on appelle <code>subscribe</code>, <code>dispatch</code> ou encore <code>getState</code> directement au sein de notre composant. Si pour une raison X ou Y, l’implémentation de store changeait, <code>getState</code> devenant <code>getCurrentState</code> pour des raisons obscures de lisibilité ;) il faudrait changer <code>getState</code> dans tous les composants qui l’utilisent…pas top.</p><p>MAIS, avec <code>connect</code>, on peut simplifier tout ça !</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line">  imports</div><div class="line">*/</div><div class="line"><span class="comment">//notre fonction connect flambant neuve !!</span></div><div class="line"><span class="keyword">import</span> &#123; connect &#125; <span class="keyword">from</span> <span class="string">"./react-redux/react-redux"</span>;</div><div class="line"><span class="comment">//nos actions toujours présentes</span></div><div class="line"><span class="keyword">import</span> &#123; addMail, removeMail, markMailAsRead &#125; <span class="keyword">from</span> <span class="string">'./redux/actions'</span>;</div><div class="line"></div><div class="line"><span class="comment">//Je pense que vous allez reconnaître ces deux bébés !</span></div><div class="line"><span class="comment">//1) les props que l'on souhaite générer avec la méthode dispatch</span></div><div class="line"><span class="keyword">const</span> mapDispatchToProps = <span class="function">(<span class="params">dispatch</span>) =&gt;</span> (&#123;</div><div class="line">  <span class="attr">addMail</span>: <span class="function"><span class="params">()</span> =&gt;</span> dispatch(addMail()),</div><div class="line">  <span class="attr">removeMail</span>: <span class="function"><span class="params">index</span> =&gt;</span> dispatch(removeMail(index)),</div><div class="line">  <span class="attr">markMailAsRead</span>: <span class="function"><span class="params">index</span> =&gt;</span> dispatch(markMailAsRead(index)),</div><div class="line">&#125;);</div><div class="line"><span class="comment">//2) les props que l'on souhaite générer depuis le state</span></div><div class="line"><span class="keyword">const</span> mapStateToProps = <span class="function">(<span class="params">state</span>) =&gt;</span> (&#123;</div><div class="line">  <span class="attr">mails</span>: state.mails,</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</div><div class="line"></div><div class="line">  hitRefreshButton = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">    <span class="keyword">const</span> newMails = <span class="built_in">Math</span>.round(<span class="built_in">Math</span>.random() * <span class="number">4</span>) + <span class="number">1</span>; </div><div class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; newMails; i++) &#123;</div><div class="line">      <span class="comment">//ADIEU STORE.DISPATCH §§§</span></div><div class="line">      <span class="keyword">this</span>.props.addMail();</div><div class="line">    &#125;;</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  render() &#123;</div><div class="line">    <span class="comment">//ici, props contient bien</span></div><div class="line">    <span class="comment">//tous les éléments définis via mapDispatchToProps et mapStateToProps</span></div><div class="line">    <span class="keyword">const</span> &#123;</div><div class="line">      mails,</div><div class="line">      addMail,</div><div class="line">      removeMail,</div><div class="line">      markMailAsRead,</div><div class="line">    &#125; = <span class="keyword">this</span>.props;</div><div class="line"></div><div class="line">    <span class="keyword">const</span> unreadMails = mails.filter(<span class="function"><span class="params">mail</span> =&gt;</span> !mail.read);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> (</div><div class="line">      &#123;<span class="comment">/* stuff */</span>&#125;</div><div class="line">        &lt;div&gt;</div><div class="line">          &lt;Label </div><div class="line">            color=&#123;mails !== 0 ? 'green' : ''&#125;</div><div class="line">          &gt;</div><div class="line">            &lt;Icon name='mail'/&gt; &#123;unreadMails.length&#125;</div><div class="line">          &lt;/Label&gt;</div><div class="line">        &lt;/div&gt;</div><div class="line">        &lt;div&gt;</div><div class="line">        &lt;Label </div><div class="line">          as="button"</div><div class="line">          content="Refresh" </div><div class="line">          icon="refresh"</div><div class="line">          onClick=&#123;this.hitRefreshButton&#125;</div><div class="line">        /&gt;</div><div class="line">        &lt;/div&gt;</div><div class="line">        &#123;mails.length === <span class="number">0</span> &amp;&amp; &lt;div style=&#123;S.centeredContainer&#125;&gt;</div><div class="line">          &lt;div&gt;No new mail, have a good day !&lt;/div&gt;</div><div class="line">        &lt;/div&gt;&#125;</div><div class="line">        &#123; mails.map( <span class="function">(<span class="params">mail, index</span>) =&gt;</span> (</div><div class="line">            &lt;Mail </div><div class="line">              key=&#123;mail.object&#125;</div><div class="line">              mail=&#123;mail&#125; </div><div class="line">              index=&#123;index&#125;</div><div class="line">              onDelete=&#123; () =&gt; removeMail(index) &#125;  </div><div class="line">              onClickAsRead=&#123; () =&gt; markMailAsRead(index)&#125;</div><div class="line">            /&gt;</div><div class="line">          ))</div><div class="line">        &#125;</div><div class="line">    );</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">//enfin on appelle effectivement connect avec les fonctions et on lie </div><div class="line">//tout ça à notre composant App </div><div class="line">export default connect(mapDispatchToProps, mapStateToProps)(App);</div></pre></td></tr></table></figure><p>Et voilà, grâce à <code>connect</code>, notre composant <code>App</code> ne s’occupe que de ses <code>props</code>, plus aucun accès à l’objet <code>store</code>, ni à ses méthodes n’est nécessaire !!</p><p>###Conclusion</p><p>Avec cette découverte de <code>react-redux</code>, on a complété notre apprentissage de <code>redux</code>. Il aurait en effet été dommage de s’arrêter en si bon chemin alors que <code>react-redux</code> est juste une librairie indispensable dès que l’on souhaite utiliser <code>redux</code> dans un projet React.</p><p>Maintenant, on comprend comment et pourquoi elle existe et nous simplifie la vie puisqu’il y a bel et bien un avant et un après <code>react-redux</code>.<br>Il suffit de le voir avec un exemple aussi simple que celui que nous avons construit au cours de l’article traitant de <code>redux</code>…</p><p>Par contre, sachez que notre version de <code>react-redux</code> est évidemment beaucoup, beaucoup, plus simple que le package officiel. J’ai délibérément négligé certains aspects de l’API offert par <code>react-redux</code>, pas à cause de la complexité mais parce qu’il ne rajouterait pas beaucoup de plus value en terme de compréhension.</p><p>Dans une toute autre mesure, <code>react-redux</code> soulève et résoud de nombreux problèmes très poussés de cohérence de la donnée causé notamment par l’asynchronisme de la méthode <code>setState</code>, de caching de component, pour répondre à des <em>edge-cases</em> rendant le code source pas très parlant à la première lecture… :) Pour ce qui désire approfondir le sujet, Dan Abramov parle de <code>react-redux</code> <a href="https://www.youtube.com/watch?v=VJ38wSFbM3A&amp;t=2070s" target="_blank" rel="noopener">ici</a> (la vidéo n’est pas de très bonne qualité malheureuseument mais le contenu oui)…</p><p>Le code détaillé dans ce poste disponible <a href="https://github.com/GaelS/fake-inbox-redux-connect" target="_blank" rel="noopener">ici</a>.</p><p>A bientôt,<br>Gaël</p><div class="tags-container-bottom"><i class="fa fa-tag pr3 text-main-color"></i><a class="fw3 ph1 dib" href="/tags/redux/">#redux</a> <a class="fw3 ph1 dib" href="/tags/react-redux/">#react-redux</a></div><div id="disqus_thread" class="mt5"><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></div><div class="fl w-100 w-30-l center fw3 lh-copy pl4-ns tl black-50"><hr class="dn-l mw4 black-50 mt5"><div class="mt5 mt0-l"><article class="dt db-l mw8 mw8-m mw5-ns center ml0-l bg-white mv3"><div class="dn dtc-m db-l v-mid tc pr4 pr0-l" style="min-width:6rem"><img src="/images/profile.jpg" class="mb4-l br-100 h3 w3 h4-l w4-l dib" title="Gaël Servaud"></div><div class="dtc db-l v-mid lh-copy measure center f6 black-50 tj">Mon nom est Gaël Servaud<br>je suis développeur web fullstack freelance avec un fort intérêt pour les problématiques front-end.<br>Avec ce blog, je souhaite partager mes découvertes, mes projets perso et mes réflexions sur la librairie React et son écosystème foisonnant.</div></article></div><hr class="dn-l mw4 black-50 mt5"><div class="mt5 tc tl-l"><h3>Catégories</h3><p><a href="/categories/tutorial/">tutorial</a></p><p><a href="/categories/tutorial/library/">library</a></p></div><hr class="dn-l mw4 black-50 mt5"><div class="mt5 tc tl-l"><h3>Récemment</h3><p><a href="/tutorial/library/state/Supprimer-Redux-en-utilisant-l-url-de-votre-application/">Supprimer Redux en utilisant l&#39;url de votre applic</a></p><p><a href="/lifestyle/code/terminer-ses-projets-perso/">Terminer ses projets perso...</a></p><p><a href="/tutorial/library/React-Redux-from-scratch/">React Redux from scratch</a></p><p><a href="/tutorial/library/flux/redux-from-scratch/">Redux from scratch</a></p><p><a href="/tutorial/debutant/render-et-virtual-dom/">React et le DOM</a></p></div></div></div></div></div></div><div class="bg-1 ph2 ph5-ns pv5"><div class="mv8"><div class="center tc"><div class="dib mh3"><a class="f3 f2-ns white dim" href="https://twitter.com/GaelS3" target="_blank"><i class="fa fa-twitter"></i></a></div><div class="dib mh3"><a class="f3 f2-ns white dim" href="https://github.com/GaelS" target="_blank"><i class="fa fa-github"></i></a></div></div><div class="f6 f5-ns center tc white pt5 fw3">All rights reserved | Gaël Servaud | 9 PEAKS | 2017</div></div></div><script type="text/javascript">var disqus_shortname="www-apprendre-react-fr";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script></body></html>