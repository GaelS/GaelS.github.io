<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Dans cet article, nous allons nous intéresser à la libraire Redux développé par Dan Abramov, membre de la core team React.Redux est une des implémenta"><meta name="author" content="Gaël Servaud"><meta property="og:title" content="Redux from scratch"><meta property="og:site_name" content="Apprendre ReactJS"><meta property="og:type" content="article"><meta name="twitter:card" content="summary"><title>Redux from scratch - Apprendre ReactJS</title><link rel="stylesheet" href="//unpkg.com/tachyons/css/tachyons.min.css"><link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"><!--[if lt IE 9]>
        <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]--><link rel="stylesheet" href="/css/style.css"><script>!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-96190899-1","auto"),ga("send","pageview")</script></head><body><div class="w-100 bg-1 ph5-ns ph3 text-light"><nav class="db dt-l w-100 mw8 center border-box pv3"><a class="db dtc-l v-mid link dim w-100 w-25-l tc tl-l mb2 mb0-l white" href="/" title="Apprendre ReactJS"><img src="/images/ReactLogo.svg" class="dib h3" alt="Apprendre ReactJS"></a><div class="db dtc-l v-mid w-100 w-75-l tc tr-l"><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/" title="Home">Home </a><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/archives" title="Archives">Archives </a><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/about" title="A propos">A propos</a></div></nav><div class="w-100 mw8 center vh-40 dt"><div class="dtc v-mid white"><h1 class="f1-l f2-m tc tc-m tl-ns">Redux from scratch</h1><p class="f4 fw3 pab-100px tc tc-m tl-ns">02/05/2017</p></div></div><div class="relative w-100 mw8 center white dn dn-m db-ns"><i class="header-icon fa fa-code"></i></div></div><div class="w-100 ph2 ph4-m ph5-l mv5 mv6-l"><div class="content"><div class="mw8 center"><div class="cf"><div class="fl w-100 w-70-l mw7 left fw3 lh-copy pr4-ns pr0-m post-content"><div class="tags-container-vertical"><div class="tags-sub-container"><a class="fw3 ph1 dib" href="/tags/redux/">#redux</a> <a class="fw3 ph1 dib" href="/tags/library/">#library</a> <a class="fw3 ph1 dib" href="/tags/flux/">#flux</a></div></div><p>Dans cet article, nous allons nous intéresser à la libraire Redux développé par Dan Abramov, membre de la core team React.</p><p>Redux est une des implémentations les plus populaires du pattern Flux, introduit par Facebook et permettant une gestion centralisée d’une application web.</p><p>Pour résumer rapidement, un évènement utilisateur (ex : clic sur un bouton) va déclencher une action, qui va mettre à jour l’état global de l’application et en retour, mettre à jour l’interface de l’application.</p><p>Mais, pour mieux comprendre le fonctionnement de Redux, nous allons le coder pas à pas pour finalement l’intégrer dans une application React.</p><h3 id="Un-state-global"><a href="#Un-state-global" class="headerlink" title="Un state global"></a>Un state global</h3><p>Le B.A.BA de la librairie Redux, c’est la gestion de l’état global (le <em>state</em>) de notre application. Pour respecter le vocabulaire Redux, nous allons créer un objet <em>store</em> chargé de gérer tout ça.</p><p>Cet objet <code>store</code> va donc posséder une variable interne <code>state</code>.<br>Celui-ci est un simple objet javascript ne pouvant pas être modifier depuis l’extérieur du <em>store</em>.</p><p>Par contre, si on ne peut pas le modifier, il faut tout de même pouvoir lire sa valeur. C’est pourquoi on crée une fonction <code>getState</code> qui retourne la valeur du <em>state</em>. Ce dernier n’est en l’état absolument pas générique et réutilisable (nous l’améliorerons par la suite).</p><p>Pour l’instant, il contient une clé <code>counter</code> initialisée à 0.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> store = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  </div><div class="line">  <span class="comment">//notre objet state</span></div><div class="line">  <span class="keyword">let</span> state = &#123; <span class="attr">counter</span>: <span class="number">0</span> &#125;;</div><div class="line">  </div><div class="line">  <span class="comment">//la methode pour accéder au</span></div><div class="line">  <span class="comment">//au state depuis l'extèrieur</span></div><div class="line">  <span class="keyword">const</span> getState = <span class="function"><span class="params">()</span> =&gt;</span> state;</div><div class="line">  <span class="comment">//on retourne les</span></div><div class="line">  <span class="comment">//fonctions que </span></div><div class="line">  <span class="comment">//l'on veut rendre accessible</span></div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    getState,</div><div class="line">  &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h3 id="Dispatcher-une-action-et-modifier-le-state"><a href="#Dispatcher-une-action-et-modifier-le-state" class="headerlink" title="Dispatcher une action et modifier le state"></a>Dispatcher une action et modifier le state</h3><p>En l’état, on ne peut pas modifier la variable counter du <code>state</code>. On va donc, en suivant le vocabulaire de Flux et Redux, permettre de <em>dispatcher</em> un event, c’est à dire informer le store qu’une action pouvant éventuellement modifier le <code>state</code> a eu lieu.</p><p>En l’occurence, pour notre exemple, on va incrémenter ou décrémenter <code>counter</code> suivant l’action que l’on envoie. Ici, on va prendre en compte deux actions, ‘ADD’ et ‘SUBSTRACT’ qui vont modifier le <code>state</code> en conséquence.</p><p>Cette action va donc être prise en compte par une nouvelle fonction <code>dispatch</code> qui prend en entrée le nom de l’action.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> Store = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; </div><div class="line"></div><div class="line">  <span class="comment">/*</span></div><div class="line">   cf. code précédent</div><div class="line">  */</div><div class="line">  <span class="keyword">const</span> dispatch = <span class="function"><span class="params">action</span> =&gt;</span> &#123;</div><div class="line">    <span class="keyword">if</span> (action === <span class="string">'ADD'</span>) &#123;</div><div class="line">      state.counter = state.counter + <span class="number">1</span>;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (action === <span class="string">'SUBSTRACT'</span>) &#123;</div><div class="line">      state.counter = state.counter - <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    getState,</div><div class="line">    dispatch,</div><div class="line">  &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>Maintenant, en plus de la lecture du <code>state</code> via <code>getState</code>, on peut donc le modifier indirectement avec la méthode <code>dispatch</code>.</p><p><img src="/images/store.gif"></p><h3 id="Rendre-notre-store-plus-generique"><a href="#Rendre-notre-store-plus-generique" class="headerlink" title="Rendre notre store plus générique"></a>Rendre notre store plus générique</h3><p>Dans l’exemple précédent, le <code>state</code> initial est <em>hardcodé</em>, ce qui n’est pas génial si l’on souhaite faire autre chose qu’un compteur…, ce qui a de forte chance d’arriver :)</p><p>On va donc modifier <code>Store</code> de tel sorte qu’il accepte en entrée un argument <code>initialState</code> (qui sera un objet vide par défaut), qui sera utilisé - comme son nom l’indique - pour assigner une état initial à notre <code>state</code>.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> Store = <span class="function"><span class="keyword">function</span>(<span class="params">initialState = &#123;&#125;</span>) </span>&#123;</div><div class="line"></div><div class="line">  <span class="comment">//notre objet state</span></div><div class="line">  <span class="keyword">let</span> state = initialState;</div><div class="line">  </div><div class="line">  <span class="comment">/*</span></div><div class="line">   cf. code précédent</div><div class="line">  */</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">const</span> initialState = &#123; <span class="attr">counter</span> : <span class="number">0</span> &#125;;</div><div class="line"><span class="comment">//instanciation de notre store </span></div><div class="line"><span class="comment">//avec le state contenant counter</span></div><div class="line"><span class="keyword">const</span> store = <span class="keyword">new</span> Store(initalState);</div></pre></td></tr></table></figure><p>De même, la fonction <code>dispatch</code> définit précédemment contient toute la logique de mise à jour en interne, il faut donc l’externaliser.</p><p>Pour réaliser cela, on amène un autre élément essentiel de Redux que l’on avait survolé: le <em>reducer</em>. Ce dernier est une fonction qui prend en argument le <code>state</code> actuel, à l’instant T et l’action qui vient d’être <em>dispatchée</em> pour retourner le <code>state</code> suivant, le nouveau <code>state</code> de notre application.</p><p>Le <em>reducer</em> sera le deuxième argument que va recevoir notre objet store à l’instanciation et va venir instancier la variable <code>reducer</code> de notre Store lors de l’instanciation.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//store.js</span></div><div class="line"><span class="keyword">const</span> Store = <span class="function"><span class="keyword">function</span>(<span class="params">initialState = &#123;&#125;, reducer</span>) </span>&#123; </div><div class="line"></div><div class="line">  <span class="comment">/*</span></div><div class="line">   cf. code précédent</div><div class="line">  */</div><div class="line"></div><div class="line">  <span class="keyword">let</span> reducer = reducer;</div><div class="line"></div><div class="line">  <span class="comment">//l'écriture de dispatch</span></div><div class="line">  <span class="comment">//est maintenant extrêmement simple</span></div><div class="line">  <span class="comment">//la logique étant externalisée</span></div><div class="line">  <span class="keyword">const</span> dispatch = <span class="function"><span class="params">action</span> =&gt;</span> &#123;</div><div class="line">    state = reducer(action, state);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    getState,</div><div class="line">    dispatch,</div><div class="line">  &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>Le reducer est maintenate un fichier à part:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//reducer.js</span></div><div class="line"><span class="keyword">const</span> reducer = <span class="function">(<span class="params">action, state</span>) =&gt;</span> &#123;</div><div class="line">  <span class="keyword">if</span> (action === <span class="string">'ADD'</span>) &#123;</div><div class="line">    <span class="keyword">return</span> &#123; <span class="attr">counter</span>: state.counter + <span class="number">1</span> &#125;;</div><div class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (action === <span class="string">'SUBSTRACT'</span>) &#123;</div><div class="line">    <span class="keyword">return</span> &#123; <span class="attr">counter</span>: state.counter - <span class="number">1</span> &#125;;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> state;</div><div class="line">&#125;;</div></pre></td></tr></table></figure><p>Pour instancier le <em>store</em>, on écrit maintenant :<br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">const</span> store = <span class="keyword">new</span> Store(initialState, reducer);</div></pre></td></tr></table></figure><p></p><p>Maintenant, on a quelque chose qui commence à ressembler pas mal au code que l’on a quand on utilise Redux. On crée un <em>store</em> en définissant un <em>state</em> initial et le <em>reducer</em> associé qui viendra le modifier.</p><p>Maintenant, fini de jouer dans la console javascript: on va tenter de lier ça à React.</p><h3 id="React-et-notre-Redux-homemade"><a href="#React-et-notre-Redux-homemade" class="headerlink" title="React et notre Redux homemade"></a>React et notre Redux <em>homemade</em></h3><p>Nous allons développer une application React très simple mais, pour rendre ça plus sympa à regarder, on va utiliser <a href="https://react.semantic-ui.com/" target="_blank" rel="noopener">react-semantic-ui</a>, une librairie qui regroupe plein de composants prêts à l’emploi.</p><p>Pour tester notre code avec React, nous allons créer une boîte mail qui affiche de faux mails. Au niveau de l’UI, deux actions seront permises par l’utilisateur via un bouton <em>refresh</em> qui va incrémenter le nombre de faux mails et un bouton <em>supprimer</em> qui va décrémenter le nombre de mails.</p><p>Cela nous permet d’utiliser quasiment tel quel le <code>store</code> que l’on vient d’écrire. On l’étoffera par la suite.</p><h4 id="React-et-notre-Redux-Etape-1"><a href="#React-et-notre-Redux-Etape-1" class="headerlink" title="React et notre Redux: Etape #1"></a>React et notre Redux: Etape #1</h4><p>Première étape, la création d’un composant React qui va accéder au contenu du <code>state</code> et l’afficher.</p><p>Dans la méthode <code>render</code>, on va donc appeler la méthode <code>getState</code> du <code>store</code> pour accéder et afficher la valeur de <code>counter</code>.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">render() &#123;</div><div class="line">  <span class="comment">//on accède au state</span></div><div class="line">  <span class="keyword">const</span> mails = store.getState().counter;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> (</div><div class="line">    &lt;div style=&#123;S.mainWrapper&#125;&gt;</div><div class="line">      &lt;div style=&#123;S.mainTitle&#125;&gt;</div><div class="line">        &lt;div style=&#123;S.title&#125;&gt;</div><div class="line">          My Inbox</div><div class="line">          &#123;' '&#125;</div><div class="line">        &lt;/div&gt;</div><div class="line">        &#123;/*Le composant Label est un composant provenant de semantic-ui */&#125;</div><div class="line">        &lt;Label&gt;</div><div class="line">          &lt;Icon name='mail'/&gt; </div><div class="line">          &#123;/* On affiche ici le nombre de mails */&#125;</div><div class="line">          &#123; mails &#125;</div><div class="line">        &lt;/Label&gt;</div><div class="line">      &lt;/div&gt;</div><div class="line">      &lt;div style=&#123;S.refreshButton&#125;&gt;</div><div class="line">        &lt;Label&gt;</div><div class="line">          &lt;Icon name='repeat' /&gt;</div><div class="line">        &lt;/Label&gt;</div><div class="line">       &lt;/div&gt;</div><div class="line">    &lt;/div&gt;</div><div class="line">  );</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>Maintenant, on va créer la méthode permettant d’incrémenter la valeur <code>counter</code> du <code>state</code> lorsque l’on clique sur le bouton <em>refresh</em>.</p><p>On va donc rajouter une méthode <code>onClick</code> au refresh button via l’ajout de la ligne <code>onClick={this.hitRefreshButton}</code> et écrire ce que va réaliser la méthode <code>hitRefreshButton</code>. En l’occurence, il s’agit ici de dispatcher une action <em>ADD</em> au store :</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hitRefreshButton = <span class="function"><span class="params">()</span> =&gt;</span> store.dispatch(<span class="string">'ADD'</span>);</div></pre></td></tr></table></figure><p>Maintenant, essayons de rafraîchir le nombre de mails en cliquant.<br>Alors…ah, rien ne se passe… Quand, on <code>console.log</code> le state, celui-ci est bien mis à jour, pourtant, le nombre de mails affichés reste désespérement à 0.</p><p><img src="/images/storeAndReactNotRefreshing.gif"></p><p><strong>Que se passe t-il ?</strong></p><p>On a un composant React qui affiche le <code>state</code> contenu dans le <code>store</code> à un instant T et deux boutons qui dispatchent des actions pour mettre à jour le state. Une fois la mise à jour terminée, le composant React est-il au courant qu’il doit effectuer un nouveau <em>rendering</em> ?</p><p><strong>NON</strong> car personne ne le prévient…</p><p>Un composant React va effectuer un nouveau <em>rendering</em> soit :</p><p>1) avec la mise à jour des <em>props</em> envoyés par son composant parent<br>2) en invoquant sa méthode interne <code>setState</code><br>3) en invoquant sa méthode interne <code>forceUpdate</code> qui comme son nom l’indique va forcer un <em>re-rendering</em>.</p><p>Ici, la première solution n’est pas applicable puisqu’il n’y pas de composant parent.</p><p>La seconde ne l’est pas non plus puisque le composant n’a pas de <code>state</code> interne. On pourrait éventuellement créer un <code>state</code> interne pour que <code>setState</code> soit appelé à chaque mise à jour du <code>state</code> global mais, cela amènerait beaucoup de code dupliqué dans chacun des composants utilisant le <code>state</code> dans leur affichage…</p><p>La troisième solution semble la plus simple : forcer un re-rendering du composant pour que l’UI affiche la valeur courant du <code>state</code> global. Il faudrait donc qu’à l’issue d’une mise à jour du <code>state</code>, le composant React soit informé qu’il doit effectuer une <em>rendering</em>: un callback.</p><p>Pour réaliser cela, nous allons ajouter une méthode <code>subscribe</code> au Store. Cette méthode prendra en argument une fonction que l’on stockera dans un tableau <code>listeners</code> (contenant uniquement des fonctions).</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> Store = <span class="function"><span class="keyword">function</span>(<span class="params">initialState = &#123;&#125;, reducer</span>) </span>&#123;</div><div class="line"></div><div class="line">  <span class="comment">/*</span></div><div class="line">   cf code précédent</div><div class="line">  */</div><div class="line"></div><div class="line">  <span class="comment">//le tableau de fonctions</span></div><div class="line">  <span class="keyword">let</span> listeners = [];</div><div class="line"></div><div class="line">  <span class="comment">//la méthode subscribe qui ajoute une fonction</span></div><div class="line">  <span class="comment">// au tableau de listeners</span></div><div class="line">  <span class="keyword">const</span> subscribe = <span class="function"><span class="params">fn</span> =&gt;</span> listeners.push(fn);</div><div class="line"></div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    getState,</div><div class="line">    dispatch,</div><div class="line">    <span class="comment">//on l'ajoute ici au fonction que</span></div><div class="line">    <span class="comment">//l'objet store expose</span></div><div class="line">    subscribe,</div><div class="line">  &#125;;</div><div class="line">&#125;;</div></pre></td></tr></table></figure><p>Maintenant, on veut que les fonctions contenues dans <em>listeners</em> soient appelées à chaque mise à jour du <code>state</code>. Ces dernières ont lieu dans la méthode <code>dispatch</code>, c’est donc à cet endroit que l’on va agir.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> Store = <span class="function"><span class="keyword">function</span>(<span class="params">initialState = &#123;&#125;, reducer</span>) </span>&#123;</div><div class="line">  </div><div class="line">  <span class="comment">//notre objet state</span></div><div class="line">  <span class="keyword">let</span> state = initialState;</div><div class="line">  </div><div class="line">  <span class="keyword">let</span> listeners = [];</div><div class="line"></div><div class="line">  <span class="comment">//la methode pour accéder au</span></div><div class="line">  <span class="comment">//au state depuis l'extèrieur</span></div><div class="line">  <span class="keyword">const</span> getState = <span class="function"><span class="params">()</span> =&gt;</span> state;</div><div class="line"></div><div class="line">  <span class="keyword">const</span> subscribe = <span class="function"><span class="params">fn</span> =&gt;</span> listeners.push(fn);</div><div class="line"></div><div class="line">  <span class="keyword">const</span> dispatch = <span class="function"><span class="params">action</span> =&gt;</span> &#123;</div><div class="line">    state = reducer(action, state);</div><div class="line">    <span class="comment">//le state vient d'être mis</span></div><div class="line">    <span class="comment">//à jour, on exécute toutes</span></div><div class="line">    <span class="comment">//les fonctions contenues</span></div><div class="line">    <span class="comment">//dans listeners</span></div><div class="line">    listeners.forEach(<span class="function"><span class="params">fn</span> =&gt;</span> fn());</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    getState,</div><div class="line">    dispatch,</div><div class="line">    subscribe,</div><div class="line">  &#125;;</div><div class="line">&#125;;</div></pre></td></tr></table></figure><p>Maintenant que le Store est capable de rappeler des callbacks à chaque mises-à-jour, il faut légèrement modifier le composant React pour qu’il fassent partie des <em>listeners</em> du <code>state</code> et se <em>rerender</em>, à chaque mise à jour de ce dernier. On va donc <em>subscriber</em> le composant React pour que sa méthode <code>forceUpdate</code> soit appelée à chaque mise à jour.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//On importe notre store bien sûr !</span></div><div class="line"><span class="keyword">import</span> store <span class="keyword">from</span> <span class="string">'./redux/store.js'</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</div><div class="line">  <span class="comment">//on veut que notre composant soit</span></div><div class="line">  <span class="comment">//tout de suite au courant des changements</span></div><div class="line">  <span class="comment">// de state, donc on réalise le subscribe</span></div><div class="line">  <span class="comment">//dans componentDidMount</span></div><div class="line">  componentDidMount() &#123;</div><div class="line">    <span class="comment">//On fournit un callback à notre store</span></div><div class="line">    <span class="comment">//tout simplement un fonction qui appelle</span></div><div class="line">    <span class="comment">//la méthode forceUpdate ! </span></div><div class="line">    store.subscribe(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">this</span>.forceUpdate());</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  hitRefreshButton = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">    store.dispatch(<span class="string">'ADD'</span>);</div><div class="line">  &#125;;</div><div class="line">  render() &#123;</div><div class="line">    <span class="comment">/* Le rendering */</span></div><div class="line">  &#125;</div></pre></td></tr></table></figure><p>Avec ceci, notre composant se met à jour quand le <code>state</code> change !</p><h4 id="React-et-notre-Redux-Etape-2"><a href="#React-et-notre-Redux-Etape-2" class="headerlink" title="React et notre Redux: Etape #2"></a>React et notre Redux: Etape #2</h4><h5 id="Un-Mail"><a href="#Un-Mail" class="headerlink" title="Un Mail"></a>Un Mail</h5><p>Pour le fun, j’ai amélioré le prototype afin d’avoir une fausse boîte mail permettant au clic sur le refresh, de générer de nouveaux mails qui peuvent être marqués comme lus ou bien supprimés.</p><p>Le store ne contient donc plus uniquement une valeur <code>counter</code> mais des faux mails générés (expéditeur, objet, contenu, etc.) grâce à Faker, une petit librairie très pratique pour mocker du contenu.</p><p>De plus, on en profite pour se rapprocher du formalisme de Redux en amenant ici l’écritre de noms d’actions et des fonctions associées :</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">const</span> ADD = <span class="string">'ADD'</span>;</div><div class="line"><span class="keyword">export</span> <span class="keyword">const</span> REMOVE = <span class="string">'REMOVE'</span>;</div><div class="line"><span class="keyword">export</span> <span class="keyword">const</span> MARK_MAIL_AS_READ = <span class="string">'MARK_MAIL_AS_READ'</span>;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">const</span> addMail = <span class="function"><span class="params">()</span> =&gt;</span> (&#123;</div><div class="line">    <span class="attr">type</span>: ADD,</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">const</span> removeMail = <span class="function"><span class="params">index</span> =&gt;</span> (&#123;</div><div class="line">    <span class="attr">type</span>: REMOVE,</div><div class="line">    <span class="attr">payload</span>: &#123; index &#125;,</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">const</span> markMailAsRead = <span class="function"><span class="params">index</span> =&gt;</span> (&#123;</div><div class="line">    <span class="attr">type</span>: MARK_MAIL_AS_READ,</div><div class="line">    <span class="attr">payload</span>: &#123; index &#125;,</div><div class="line">&#125;);</div></pre></td></tr></table></figure><p>De cette façon, au sein d’un composant React, on génère un mail de la façon suivante :<br><code>store.dispatch(addMail());</code></p><p>On obtient donc ça:</p><p><img src="/images/final.gif"></p><p>Le code complet est disponible sur Github : <a href="https://github.com/GaelS/fake-inbox-redux" target="_blank" rel="noopener">https://github.com/GaelS/fake-inbox-redux</a></p><h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>En peu de lignes de code, nous avons finalement crée un petit manager de state global que nous avons intégré dans une application React. L’exercice est très sympa pour démystifier Redux, cette librairie incontournable de l’écosystème React.</p><p>Maintenant, les limites de l’exercice sont que l’on se retrouve à devoir ajouter une méthode <code>componentDidMount</code> pour forcer l’update de tous les composants dont le rendu est lié au state. De même, on doit logiquement importer le <code>store</code> lorsque l’on souhaite accéder au méthode <code>dispatch</code>, <code>subscribe</code> ou <code>getState</code>.</p><p>On verra dans un prochain article comment améliorer cette connexion entre React et Redux…</p><p>Teaser: je pense que la librairie react-redux sera notre amie pour l’inspiration :)</p><p>Merci de m’avoir lu et n’hésitez pas à laisser un commentaire juste en dessous.</p><div class="tags-container-bottom"><i class="fa fa-tag pr3 text-main-color"></i><a class="fw3 ph1 dib" href="/tags/redux/">#redux</a> <a class="fw3 ph1 dib" href="/tags/library/">#library</a> <a class="fw3 ph1 dib" href="/tags/flux/">#flux</a></div><div id="disqus_thread" class="mt5"><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></div><div class="fl w-100 w-30-l center fw3 lh-copy pl4-ns tl black-50"><hr class="dn-l mw4 black-50 mt5"><div class="mt5 mt0-l"><article class="dt db-l mw8 mw8-m mw5-ns center ml0-l bg-white mv3"><div class="dn dtc-m db-l v-mid tc pr4 pr0-l" style="min-width:6rem"><img src="/images/profile.jpg" class="mb4-l br-100 h3 w3 h4-l w4-l dib" title="Gaël Servaud"></div><div class="dtc db-l v-mid lh-copy measure center f6 black-50 tj">Mon nom est Gaël Servaud<br>je suis développeur web fullstack freelance avec un fort intérêt pour les problématiques front-end.<br>Avec ce blog, je souhaite partager mes découvertes, mes projets perso et mes réflexions sur la librairie React et son écosystème foisonnant.</div></article></div><hr class="dn-l mw4 black-50 mt5"><div class="mt5 tc tl-l"><h3>Catégories</h3><p><a href="/categories/tutorial/">tutorial</a></p><p><a href="/categories/tutorial/library/">library</a></p><p><a href="/categories/tutorial/library/flux/">flux</a></p></div><hr class="dn-l mw4 black-50 mt5"><div class="mt5 tc tl-l"><h3>Récemment</h3><p><a href="/conseil/coder-et-rester-motiver/">Terminer ses projets perso...</a></p><p><a href="/tutorial/library/React-Redux-from-scratch/">React Redux from scratch</a></p><p><a href="/tutorial/library/flux/redux-from-scratch/">Redux from scratch</a></p><p><a href="/tutorial/debutant/render-et-virtual-dom/">React et le DOM</a></p><p><a href="/tutorial/debutant/jsx/">Les bases du JSX</a></p></div></div></div></div></div></div><div class="bg-1 ph2 ph5-ns pv5"><div class="mv8"><div class="center tc"><div class="dib mh3"><a class="f3 f2-ns white dim" href="https://twitter.com/GaelS3" target="_blank"><i class="fa fa-twitter"></i></a></div><div class="dib mh3"><a class="f3 f2-ns white dim" href="https://github.com/GaelS" target="_blank"><i class="fa fa-github"></i></a></div></div><div class="f6 f5-ns center tc white pt5 fw3">All rights reserved | Gaël Servaud | 9 PEAKS | 2017</div></div></div><script type="text/javascript">var disqus_shortname="www-apprendre-react-fr";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script></body></html>